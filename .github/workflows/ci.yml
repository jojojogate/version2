name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        coverage: xdebug

    - name: Install Composer dependencies
      run: |
        if [ -f composer.json ]; then
          composer install
        fi

    - name: Run PHPUnit tests
      run: |
        if [ -f vendor/bin/phpunit ]; then
          vendor/bin/phpunit --coverage-clover coverage.xml tests
        fi

    - name: Dependency Check (Composer + npm)
      run: |
        if [ -f composer.json ]; then
          composer outdated || true
        fi
        if [ -f package.json ]; then
          npm install
          npm audit || true
        fi

    - name: Simple HTTP Test
      run: |
        php -S 127.0.0.1:8000 -t repos/version2 & 
        sleep 5
        curl -s http://127.0.0.1:8000/index.php || true

    - name: ESLint Security Scan
      run: |
        if [ -f package.json ]; then
          npm install eslint eslint-plugin-security --save-dev
          npx eslint . --ext .js --plugin security
        else
          echo "No JavaScript files found, skipping ESLint"
        fi

    - name: SonarQube Scan
      uses: sonarsource/sonarqube-scan-action@v2
      env:
        SONAR_HOST_URL: "http://127.0.0.1:9000"
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.projectKey=version2
          -Dsonar.sources=.
          -Dsonar.php.coverage.reportPaths=coverage.xml
